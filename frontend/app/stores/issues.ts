import type { FuseResult, IFuseOptions } from 'fuse.js';
import type FuseType from 'fuse.js';

export interface IFaqIssue {
    id: number | string;
    title: string;
    blocks: {
        title: string;
        content: string;
        articleId?: string | number;
    }[];
}

export const useIssuesStore = defineStore('issues', () => {
    //State
    const issuesList = useState<IFaqIssue[] | null>('issuesList', () => null);
    const fuse = shallowRef<FuseType<IFaqIssue> | null>(null);

    // temp-data =====================================================================
    issuesList.value = [
        {
            id: '96406916-be18-4a41-83b5-41bdc3047625',
            title: 'О работе бюро',
            blocks: [
                {
                    title: 'Сколько стоят ваши услуги??',
                    content:
                        'В Инспекции имущества Канады мы обязуемся защищать вашу личную информацию и уважать вашу конфиденциальность. Настоящая Политика конфиденциальности объясняет, как мы собираем, используем, раскрываем и защищаем вашу информацию, когда вы используете наши услуги по проверке имущества.',
                },
                {
                    title: 'Какие гарантии вы предоставляете?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Какие у вас есть лицензии??',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
            ],
        },
        {
            id: '27d7ae5d-c9b4-435b-a284-0c95e7dd5da0',
            title: 'Уголовное право',
            blocks: [
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Популярность ведения бизнеса именно таким способом возрастает, как и объем недовольств и претензий потребителей, хотя способ реализации товаров, услуг и работ именно дистанционным способом, был всегда подконтролен Роспотребнадзору.',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Lorem ipsum dolor, sit amet consectetur adipisicing elit. Magni repellat harum blanditiis id deserunt, delectus veniam molestias neque, eum, sapiente saepe? Alias temporibus vel nihil?',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
            ],
        },
        {
            id: 'e8ee6fb4-0cc3-4058-acf6-f6bf861e2e82',
            title: 'Гражданское право',
            blocks: [
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
                {
                    title: 'Я был лишён водительского удостоверения по ч.1 ст. 264 УК РФ, условно дали два года и лишение прав на два года. Прошло 1.5 года, меня вновь остановили не трезвым и оформили по ст ч.2 ст. 12.7 КоАП РФ и ст. 264 УК РФ. Почему меня оформили по ст ч.2 ст. 12.7 КоАП РФ?',
                    content:
                        'Для юридических лиц можно пройти аттестацию в одном из государственных аттестационных центрах. Описание – основной смысл. Используйте 1-2 предложения в 1-3 строчки, если выравнивание по центру. При большем количестве текста используйте другой тип выравнивания контента',
                },
            ],
        },
    ];
    // ===============================================================================

    const fuseOptions: IFuseOptions<IFaqIssue> = {
        keys: ['blocks.title', 'blocks.content'],
        threshold: 0.35,
        ignoreLocation: true,
        includeMatches: true,
    };

    async function initFuseIfNeeded(): Promise<void> {
        if (fuse.value) return;
        const list = issuesList.value;
        if (!list || !list.length) return;
        const { default: Fuse } = await import('fuse.js');
        fuse.value = new Fuse(list, fuseOptions);
    }

    watch(
        issuesList,
        (newList) => {
            if (!newList?.length) {
                fuse.value = null;
                return;
            }
            import('fuse.js').then(({ default: Fuse }) => {
                fuse.value = new Fuse(newList, fuseOptions);
            });
        },
        { immediate: false }
    );

    async function searchIssueFuzzy(query: string): Promise<IFaqIssue[]> {
        const list = issuesList.value ?? [];
        if (!query.trim()) return list;

        await initFuseIfNeeded();
        if (!fuse.value) return list;

        const results: FuseResult<IFaqIssue>[] = fuse.value.search(query);

        const filteredIssues: IFaqIssue[] = results.map((res) => {
            const matchedBlocks = new Set<number>();

            res.matches?.forEach((m) => {
                if (m.key?.startsWith('blocks')) {
                    const idx = m.refIndex ?? null;
                    if (typeof idx === 'number') matchedBlocks.add(idx);
                }
            });

            const filteredBlocks = res.item.blocks.filter((_, idx) => matchedBlocks.has(idx));

            return {
                ...res.item,
                blocks: filteredBlocks,
            };
        });

        return filteredIssues;
    }

    return { issuesList, searchIssueFuzzy };
});
